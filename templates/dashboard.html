{% extends "base.html" %}

{% block title %}Dashboard - Network Automation{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                Network Dashboard
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="fas fa-plus me-1"></i>Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-gradient rounded-circle p-3">
                            <i class="fas fa-server text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="card-title text-muted mb-0">Total Devices</h5>
                        <h2 class="mb-0" id="totalDevices">{{ stats.total_devices or 0 }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-gradient rounded-circle p-3">
                            <i class="fas fa-check-circle text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="card-title text-muted mb-0">Online</h5>
                        <h2 class="mb-0 text-success" id="onlineDevices">{{ stats.online_devices or 0 }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-danger bg-gradient rounded-circle p-3">
                            <i class="fas fa-exclamation-circle text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="card-title text-muted mb-0">Offline</h5>
                        <h2 class="mb-0 text-danger" id="offlineDevices">{{ stats.offline_devices or 0 }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-gradient rounded-circle p-3">
                            <i class="fas fa-bell text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="card-title text-muted mb-0">Alerts</h5>
                        <h2 class="mb-0 text-warning" id="totalAlerts">{{ stats.total_alerts or 0 }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Monitoring -->
<div class="row g-4 mb-4">
    <!-- Network Performance Chart -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2 text-primary"></i>
                    Network Performance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Device Status Distribution -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                    Device Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Alerts -->
<div class="row g-4">
    <!-- Recent Alerts -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    Recent Alerts
                </h5>
                <a href="{{ url_for('security') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="recentAlerts">
                    <div class="list-group-item text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading alerts...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2 text-info"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="recentActivity">
                    <div class="list-group-item d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success rounded-circle p-2">
                                <i class="fas fa-plus text-white fa-sm"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Dashboard Initialized</h6>
                            <small class="text-muted">{{ stats.last_updated or 'Just now' }}</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info rounded-circle p-2">
                                <i class="fas fa-sync text-white fa-sm"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Monitoring Started</h6>
                            <small class="text-muted">System monitoring is active</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Device
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="hostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="hostname" name="hostname" required>
                        </div>
                        <div class="col-md-6">
                            <label for="ip_address" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" required 
                                   pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        </div>
                        <div class="col-md-6">
                            <label for="device_type" class="form-label">Device Type</label>
                            <select class="form-select" id="device_type" name="device_type" required>
                                <option value="">Select Device Type</option>
                                <option value="cisco_ios">Cisco IOS</option>
                                <option value="cisco_nxos">Cisco NX-OS</option>
                                <option value="cisco_asa">Cisco ASA</option>
                                <option value="juniper_junos">Juniper JunOS</option>
                                <option value="arista_eos">Arista EOS</option>
                                <option value="hp_procurve">HP ProCurve</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="vendor" class="form-label">Vendor</label>
                            <select class="form-select" id="vendor" name="vendor">
                                <option value="">Select Vendor</option>
                                <option value="cisco">Cisco</option>
                                <option value="juniper">Juniper</option>
                                <option value="arista">Arista</option>
                                <option value="hp">HP</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="col-md-6">
                            <label for="enable_password" class="form-label">Enable Password (Optional)</label>
                            <input type="password" class="form-control" id="enable_password" name="enable_password">
                        </div>
                        <div class="col-md-6">
                            <label for="port" class="form-label">SSH Port</label>
                            <input type="number" class="form-control" id="port" name="port" value="22" min="1" max="65535">
                        </div>
                        <div class="col-12">
                            <label for="description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addDevice()">
                    <i class="fas fa-plus me-1"></i>Add Device
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard JavaScript
let performanceChart = null;
let statusChart = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadRecentAlerts();
    startAutoRefresh();
});

// Initialize charts
function initializeCharts() {
    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Response Time (ms)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }, {
                label: 'CPU Usage (%)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Online', 'Offline'],
            datasets: [{
                data: [{{ stats.online_devices or 0 }}, {{ stats.offline_devices or 0 }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Load recent alerts
function loadRecentAlerts() {
    fetch('/api/alerts')
        .then(response => response.json())
        .then(data => {
            const alertsContainer = document.getElementById('recentAlerts');
            
            if (data.status === 'success' && data.alerts.length > 0) {
                alertsContainer.innerHTML = '';
                
                data.alerts.slice(0, 5).forEach(alert => {
                    const alertItem = document.createElement('div');
                    alertItem.className = 'list-group-item d-flex align-items-center';
                    
                    const severityClass = {
                        'critical': 'danger',
                        'high': 'warning',
                        'medium': 'info',
                        'low': 'secondary'
                    }[alert.severity] || 'secondary';
                    
                    alertItem.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="bg-${severityClass} rounded-circle p-2">
                                <i class="fas fa-exclamation text-white fa-sm"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">${alert.alert_type.replace('_', ' ').toUpperCase()}</h6>
                            <small class="text-muted">${alert.message}</small>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="badge bg-${severityClass}">${alert.severity}</span>
                        </div>
                    `;
                    
                    alertsContainer.appendChild(alertItem);
                });
            } else {
                alertsContainer.innerHTML = `
                    <div class="list-group-item text-center text-muted py-4">
                        <i class="fas fa-check-circle me-2 text-success"></i>
                        No recent alerts
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading alerts:', error);
        });
}

// Refresh dashboard data
function refreshDashboard() {
    showLoading('Refreshing dashboard data...');
    
    fetch('/api/metrics')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateDashboardStats(data.metrics);
                updateCharts(data.metrics);
            }
            hideLoading();
        })
        .catch(error => {
            console.error('Error refreshing dashboard:', error);
            hideLoading();
            showAlert('Error refreshing dashboard data', 'danger');
        });
        
    loadRecentAlerts();
}

// Update dashboard statistics
function updateDashboardStats(metrics) {
    document.getElementById('totalDevices').textContent = metrics.total_devices || 0;
    document.getElementById('onlineDevices').textContent = metrics.online_devices || 0;
    document.getElementById('offlineDevices').textContent = metrics.offline_devices || 0;
    document.getElementById('totalAlerts').textContent = metrics.alerts_count || 0;
}

// Update charts with new data
function updateCharts(metrics) {
    // Update status chart
    statusChart.data.datasets[0].data = [
        metrics.online_devices || 0,
        metrics.offline_devices || 0
    ];
    statusChart.update();
    
    // Update performance chart (simplified - would use real time series data)
    const now = new Date().toLocaleTimeString();
    performanceChart.data.labels.push(now);
    performanceChart.data.datasets[0].data.push(metrics.average_response_time || 0);
    performanceChart.data.datasets[1].data.push(metrics.performance_summary?.avg_cpu || 0);
    
    // Keep only last 10 data points
    if (performanceChart.data.labels.length > 10) {
        performanceChart.data.labels.shift();
        performanceChart.data.datasets[0].data.shift();
        performanceChart.data.datasets[1].data.shift();
    }
    
    performanceChart.update();
}

// Add new device
function addDevice() {
    const form = document.getElementById('addDeviceForm');
    const formData = new FormData(form);
    const deviceData = Object.fromEntries(formData.entries());
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    showLoading('Adding device...');
    
    fetch('/api/devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.status === 'success') {
            showAlert('Device added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
            form.reset();
            refreshDashboard();
        } else {
            showAlert('Error adding device: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error adding device:', error);
        showAlert('Error adding device', 'danger');
    });
}

// Auto refresh every 30 seconds
function startAutoRefresh() {
    setInterval(refreshDashboard, 30000);
}

// Initial load of recent data
setTimeout(refreshDashboard, 1000);
</script>
{% endblock %}
